--CURRENT_DATESELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_OPP_ACCT

-- CREATE OR REPLACE TABLE NEW AS SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_OPP_ACCT
-- WHERE __LOAD_TIMESTAMP__ IS NULL
-- SELECT * FROM NEW
-- CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_OPP_ACCT AS SELECT * FROM NEW


USE ROLE SBX_EA_GENERAL_FR;
USE DATABASE SBX_PSAS_DB;
USE SCHEMA ANALYTICS;
USE WAREHOUSE SBX_EA_GENERAL_FR_WH;

-- SHOW TASKS LIKE 'TSK_KEVIN_B_CPH_FY25_RVM%';
-- DESC TASK TSK_KEVIN_B_CPH_FY25_RVM;
select *  from table(SBX_PSAS_DB.INFORMATION_SCHEMA.task_history(
    scheduled_time_range_start=>dateadd('hour',-24,current_timestamp()),
    result_limit => 10,
    task_name=>'TSK_KEVIN_B_CPH_FY25_RVM'));
    
-- alter task TSK_KEVIN_B_CPH_FY25_RVM resume; --It was by default suspended  ( run this command Only first time since by default its suspended)
execute task TSK_KEVIN_B_CPH_FY25_RVM;

--TASK
CREATE OR REPLACE TASK TSK_KEVIN_B_CPH_FY25_RVM

WAREHOUSE = SBX_EA_GENERAL_FR_WH
SCHEDULE = 'USING CRON 50 6 * * 1-5 America/Chicago' -- 6:50 AM on weekdays
TIMESTAMP_INPUT_FORMAT = 'YYYY-MM-DD HH24'
AS

-- -------------
CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM AS

--REAR VIEW MIRROR FY23 SCRIPT

--PULL MAX SALES DATE FOR ACTUALS
WITH 
-- CREATE OR REPLACE TABLE 
MAX_DATE AS (
SELECT  MAX(PERIOD) MAX_PERIOD
FROM    DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_GROSS_PROFIT
WHERE   MARKET_SEGMENT = 'Retail'),


--IDENTIFY OPPORTUNITIES
-- CREATE OR REPLACE TABLE 
OPP_PREP AS (
SELECT * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_COMP_REQUEST_VERIFICATION WHERE OPPORTUNITY_ID NOT IN ('006HQ00001IMLMLIAO','006HQ00001IDSCXIAI','006HQ00001IDSCSIAI')
UNION 
SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_VERIFICATION WHERE OPPORTUNITY_ID <>'006HQ00001T4I6VIAV'),

-- CREATE OR REPLACE TEMPORARY TABLE NEW AS 
-- SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_VERIFICATION
-- UNION 
-- SELECT * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_COMP_REQUEST_VERIFICATION WHERE OPPORTUNITY_ID IN ('006HQ00001IDSCXIAI','006HQ00001IDSCSIAI')

-- UPDATE NEW
-- SET SIGNINGTYPE = 'NEW BUSINESS'
-- WHERE OPPORTUNITY_ID IN ('006HQ00001IDSCXIAI','006HQ00001IDSCSIAI');

-- SELECT * FROM NEW

-- CREATE OR REPLACE TABLE SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_VERIFICATION AS SELECT * FROM NEW

-- CREATE OR REPLACE TABLE 
OPP AS (
--SELECT TOP 10 * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_COMP_REQUEST_VERIFICATION

SELECT      OPPORTUNITY_ID,
            CLOSEDATE AS CLOSE_DT,
            PAIDPAYEE AS PAYEE_ID,
            PAIDPAYEENAME AS PAYEE_NAME,
            PAYEETYPE AS PAYEE_TYPE,
            SPLITPCT AS SPLIT_PCT,
            ESTTOTALPOINTS AS EST_TOTAL_POINTS,
            CAST(PART1SUBMITDATE AS DATE) AS SUBMIT_DATE
FROM        OPP_PREP
WHERE       COMPONENT_ID = 'CR ADVANCE PART I'
AND         SIGNINGTYPE = 'NEW BUSINESS'
AND         PART1STATUS = 'APPROVED'
AND         TO_DATE(CLOSEDATE) >= '04/01/2024' --FY24 ONLY
AND         TO_DATE(CLOSEDATE) <= '03/31/2025' --FY24 ONLY
GROUP BY    OPPORTUNITY_ID,
            CLOSEDATE,
            PAIDPAYEE,
            PAIDPAYEENAME,
            PAYEETYPE,
            SPLITPCT,
            ESTTOTALPOINTS,
            CAST(PART1SUBMITDATE AS DATE)),

-- CREATE OR REPLACE TABLE 
OPP_ACCT_PREP AS (
SELECT * FROM SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM_OPP_ACCT
UNION 
SELECT * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_OPPORTUNITY_ACCOUNTS
WHERE PART1STATUS='APPROVED'
),

--IDENTIFY ACCOUNTS ASSOCIATED WITH OPPORTUNITIES
-- CREATE OR REPLACE TABLE 
OPP_ACCT AS (
--SELECT TOP 10 * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_OPPORTUNITY_ACCOUNTS

SELECT      OPP.OPPORTUNITY_ID,
            CLOSE_DT,
            PAYEE_ID,
            PAYEE_NAME,
            PAYEE_TYPE,
            SPLIT_PCT,
            ACCOUNT_ID,
            ACCOUNT_NAME,
            EST_TOTAL_POINTS,
            PART1APPROVEDATE,
            PART1STATUS,
            SUBMIT_DATE
FROM        OPP
-- JOIN        DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_OPPORTUNITY_ACCOUNTS
-- ON          OPP.OPPORTUNITY_ID = V_PE_OPPORTUNITY_ACCOUNTS.OPPORTUNITY_ID
JOIN OPP_ACCT_PREP PREP
ON          OPP.OPPORTUNITY_ID = PREP.OPPORTUNITY_ID
GROUP BY    OPP.OPPORTUNITY_ID,
            CLOSE_DT,
            PAYEE_ID,
            PAYEE_NAME,
            PAYEE_TYPE,
            SPLIT_PCT,
            ACCOUNT_ID,
            ACCOUNT_NAME,
            EST_TOTAL_POINTS,
            PART1APPROVEDATE,
            PART1STATUS,
            SUBMIT_DATE),

--ADD GP ACTUAL + SPLITS TO OPP ACCT LIST
-- CREATE OR REPLACE TABLE 
OPP_ACT AS (
-- SELECT TOP 10 * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_GROSS_PROFIT_ACTUAL 

SELECT      OPP_ACCT.OPPORTUNITY_ID,
            OPP_ACCT.CLOSE_DT,
            OPP_ACCT.PAYEE_ID,
            OPP_ACCT.PAYEE_NAME,
            OPP_ACCT.PAYEE_TYPE,
            OPP_ACCT.ACCOUNT_ID,
            OPP_ACCT.ACCOUNT_NAME,
            OPP_ACCT.PART1APPROVEDATE,
            OPP_ACCT.PART1STATUS,
            CALENDAR_MONTH AS PERIOD,
            OPP_ACCT.SUBMIT_DATE,
            OPP_ACCT.SPLIT_PCT,
            OPP_ACCT.EST_TOTAL_POINTS,
            (OPP_ACCT.EST_TOTAL_POINTS * SPLIT_PCT) AS EST_TOTAL_POINTS_ADJ,
            SUM(GROSS_PROFIT_ACTUALS) AS GROSS_PROFIT_ACT,
            SUM(GROSS_PROFIT_ACTUALS * SPLIT_PCT) AS GROSS_PROFIT_ACT_ADJ,
            SUM(NET_REVENUE) AS NET_REVENUE_ACT,
            SUM(NET_REVENUE * SPLIT_PCT) AS NET_REVENUE_ACT_ADJ
FROM        OPP_ACCT
JOIN        DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_GROSS_PROFIT_ACTUAL
ON          OPP_ACCT.ACCOUNT_ID = V_PE_GROSS_PROFIT_ACTUAL.ACCOUNT_ID
WHERE       MARKET_SEGMENT = 'Retail'
AND         CALENDAR_MONTH IN ('APRIL 2024','MAY 2024','JUNE 2024','JULY 2024','AUGUST 2024','SEPTEMBER 2024','OCTOBER 2024',
            'NOVEMBER 2024','DECEMBER 2024','JANUARY 2025','FEBRUARY 2025','MARCH 2025')
GROUP BY    OPP_ACCT.OPPORTUNITY_ID,
            OPP_ACCT.CLOSE_DT,
            OPP_ACCT.PAYEE_ID,
            OPP_ACCT.PAYEE_NAME,
            OPP_ACCT.PAYEE_TYPE,
            OPP_ACCT.ACCOUNT_ID,
            OPP_ACCT.ACCOUNT_NAME,
            OPP_ACCT.PART1APPROVEDATE,
            OPP_ACCT.PART1STATUS,
            CALENDAR_MONTH,
            OPP_ACCT.SUBMIT_DATE,
            OPP_ACCT.SPLIT_PCT,
            OPP_ACCT.EST_TOTAL_POINTS,
            (OPP_ACCT.EST_TOTAL_POINTS * SPLIT_PCT)),

--PAYEE ELGIBILITY
-- CREATE OR REPLACE TABLE 
ELIG AS (
--SELECT TOP 10 * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_PAYEE_ACCOUNT_TARGETS

SELECT      OPP.PAYEE_ID,
            OPP.PAYEE_NAME,
            COMPPLANID AS COMP_PLAN_ID,
            EFFECTIVE_START,
            EFFECTIVE_END
FROM        OPP
JOIN        DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_PAYEE_PLAN_ASSIGNMENT
ON          OPP.PAYEE_ID = V_PE_PAYEE_PLAN_ASSIGNMENT.PAYEEID
AND         V_PE_PAYEE_PLAN_ASSIGNMENT.COMPPLANID NOT LIKE '%MHS%'
AND         V_PE_PAYEE_PLAN_ASSIGNMENT.EFFECTIVE_END >= '2024-04-01'
AND         V_PE_PAYEE_PLAN_ASSIGNMENT.COMPPLANID NOT LIKE 'USP_RETAIL_SM'
--AND         V_PE_PAYEE_PLAN_ASSIGNMENT.VPS_NAME NOT LIKE 'VPS NOT FOUND'
GROUP BY    OPP.PAYEE_ID,
            OPP.PAYEE_NAME,
            COMPPLANID,
            EFFECTIVE_START,
            EFFECTIVE_END),

--VPS 
-- CREATE OR REPLACE TABLE 
VPS AS (
SELECT  ACCOUNT_ID,
        PAYEE_ID, 
        PAYEE_NAME
FROM    DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_GROSS_PROFIT
WHERE   MARKET_SEGMENT = 'Retail'
AND     ROLE = 'USP_RETAIL_SM'
AND PERIOD IN (SELECT MAX_PERIOD FROM MAX_DATE) 
AND ACCOUNT_ID <> 0
GROUP BY ACCOUNT_ID,
        PAYEE_ID, 
        PAYEE_NAME
UNION
SELECT  ACCOUNTID AS ACCOUNT_ID,
        PAYEEID AS PAYEE_ID, 
        PAYEENAME AS PAYEE_NAME
FROM    DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_PAYEE_ACCOUNT_TARGETS
WHERE   COMPPLAN NOT LIKE '%MHS%'
AND     PRODUCTGROUP = 'GROSS PROFIT'
--AND     GOALTYPEID = 'ACCOUNT GOAL'
AND     COMPPLAN = 'USP_RETAIL_SM'
AND MONTH IN (SELECT MAX_PERIOD FROM MAX_DATE) 
AND ACCOUNTID <> 0
GROUP BY ACCOUNTID,
        PAYEEID, 
        PAYEENAME),

--PAYEE ELGIBILITY
-- CREATE OR REPLACE TABLE 
HIERARCHY AS (
--SELECT TOP 10 * FROM DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_FILTER_DATA_NO_ACCT 

SELECT      ELIG.PAYEE_ID,
            ELIG.PAYEE_NAME,
            ELIG.COMP_PLAN_ID,
            EFFECTIVE_START,
            EFFECTIVE_END
FROM        ELIG
WHERE       (ELIG.COMP_PLAN_ID = 'USP_RSM'
OR          ELIG.COMP_PLAN_ID = 'USP_COMBO'
OR          ELIG.COMP_PLAN_ID = 'USP_RSE')
GROUP BY    ELIG.PAYEE_ID,
            ELIG.PAYEE_NAME,
            ELIG.COMP_PLAN_ID,
            EFFECTIVE_START,
            EFFECTIVE_END),

 
--AVP
-- CREATE OR REPLACE TABLE 
AVP_PREP AS (
SELECT    REP_ID, REP_NAME, VPS_ID, VPS_NAME, AVP_TITLE,
          CASE WHEN REP_ID IN ('122251','258211','305424','182704','305444','263597','233059') THEN '271720' ELSE AVP_ID END AVP_ID, 
          CASE WHEN REP_ID IN ('122251','258211','305424','182704','305444','263597','233059') THEN 'Sangani, Roopa Arora' ELSE AVP_NAME END AVP_NAME, 
          EFFECTIVE_START, EFFECTIVE_END
FROM      DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_FILTER_DATA_NO_ACCT
LEFT JOIN DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_PAYEE_PLAN_ASSIGNMENT
ON        V_PE_FILTER_DATA_NO_ACCT.REP_ID = V_PE_PAYEE_PLAN_ASSIGNMENT.PAYEEID
WHERE     V_PE_FILTER_DATA_NO_ACCT.VPS_ID <> 'VPS NOT FOUND'
AND       V_PE_FILTER_DATA_NO_ACCT.REP_ROLE_ID NOT LIKE '%MHS%'
AND       V_PE_PAYEE_PLAN_ASSIGNMENT.EFFECTIVE_END >= '2024-04-01'
GROUP BY  REP_ID, REP_NAME, VPS_ID, VPS_NAME, AVP_TITLE,
          CASE WHEN REP_ID IN ('122251','258211','305424','182704','305444','263597','233059') THEN '271720' ELSE AVP_ID END, 
          CASE WHEN REP_ID IN ('122251','258211','305424','182704','305444','263597','233059') THEN 'Sangani, Roopa Arora' ELSE AVP_NAME END,
          EFFECTIVE_START, EFFECTIVE_END),

-- CREATE OR REPLACE TABLE 
AVP AS (
SELECT DISTINCT   VPS_ID,VPS_NAME,AVP_ID,AVP_NAME,AVP_TITLE
FROM AVP_PREP
GROUP BY VPS_ID,VPS_NAME,AVP_ID,AVP_NAME,AVP_TITLE),

-- CREATE OR REPLACE TABLE 
FINAL AS (
SELECT      OPP_ACT.*,
            HIERARCHY.COMP_PLAN_ID,
            HIERARCHY.EFFECTIVE_START,
            HIERARCHY.EFFECTIVE_END,
            CASE WHEN OPP_ACT.OPPORTUNITY_ID='006HQ00001T4I6VIAV' THEN '58250'
                 WHEN AVP.AVP_NAME IS NULL THEN '999999' 
                 ELSE AVP.AVP_ID END AS "AVP_ID",
            CASE WHEN OPP_ACT.OPPORTUNITY_ID='006HQ00001T4I6VIAV' THEN 'Marshall,JeffersonLee'
                 WHEN AVP.AVP_NAME IS NULL THEN 'Unassigned' 
                 ELSE AVP.AVP_NAME END AS "AVP_NAME",
            CASE WHEN OPP_ACT.OPPORTUNITY_ID='006HQ00001T4I6VIAV' THEN 'Area Vice President, Field Sales'
                 WHEN AVP.AVP_NAME IS NULL THEN 'Vice President, Field Sales' 
                 ELSE AVP.AVP_TITLE END AS "AVP_TITLE",
            CASE WHEN OPP_ACT.OPPORTUNITY_ID='006HQ00001T4I6VIAV' THEN '198657'
                 WHEN VPS.PAYEE_NAME IS NULL THEN '999999' 
                 ELSE VPS.PAYEE_ID END AS "VPS_ID",
            CASE WHEN OPP_ACT.OPPORTUNITY_ID='006HQ00001T4I6VIAV' THEN 'Antonson,CaseyJ.'
                 WHEN VPS.PAYEE_NAME IS NULL THEN 'Unassigned' 
                 ELSE VPS.PAYEE_NAME END AS "VPS_NAME"
FROM        OPP_ACT
LEFT JOIN   HIERARCHY
ON          OPP_ACT.PAYEE_ID = HIERARCHY.PAYEE_ID
LEFT JOIN   VPS VPS
ON          VPS.ACCOUNT_ID=OPP_ACT.ACCOUNT_ID
LEFT JOIN   AVP AVP
ON          AVP.VPS_ID=VPS.PAYEE_ID
WHERE       HIERARCHY.COMP_PLAN_ID IS NOT NULL
-- AND         AVP.AVP_NAME NOT IN ('Sangani, Roopa Arora')
AND         OPP_ACT.CLOSE_DT BETWEEN HIERARCHY.EFFECTIVE_START AND HIERARCHY.EFFECTIVE_END)

SELECT * FROM FINAL WHERE AVP_NAME NOT IN ('Sangani, Roopa Arora') AND AVP_TITLE NOT IN ('VicePresident,Strategy')



--UPDATE TO CLEAN-UP VPS NOT FOUND
-- UPDATE   SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM
-- SET      AVP_ID =  '999999', AVP_NAME = 'Unassigned', AVP_TITLE = 'Vice President, Field Sales', VPS_ID = '999999', VPS_NAME = 'Unassigned'
-- WHERE    VPS_NAME IS NULL;

-- select * from SBX_PSAS_DB.SALES_OPS_GOV.CPH_FY25_RVM WHERE OPPORTUNITY_ID IN ('006HQ00001IMLMLIAO')


-- select * from OPP_ACCT where OPPORTUNITY_ID='0063P000010AMNJAAS';
-- select * from DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_GROSS_PROFIT_ACTUAL where ACCOUNT_ID='152265';
-- select * from DEV_ENT_PL_DATALAKE_DB.VARICENT.V_PE_FILTER_DATA_NO_ACCT where rep_id=2529